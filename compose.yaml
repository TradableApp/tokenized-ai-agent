services:
  ollama:
    image: "docker.io/ollama/ollama"
    ports:
      - "11434:11434"
    volumes:
      - /storage/ollama:/root/.ollama
    entrypoint:
      ["/usr/bin/bash", "-c", "/bin/ollama serve & sleep 5; ollama pull deepseek-r1:1.5b; wait"]

  oracle:
    build:
      dockerfile: ./Dockerfile.oracle
    image: ghcr.io/tradableapp/tokenized-ai-agent:base-testnet
    platform: linux/amd64
    entrypoint: /bin/sh -c 'node src/index.js --network baseSepolia --ollama-address http://ollama:11434'
    restart: on-failure
    volumes:
      - /run/rofl-appd.sock:/run/rofl-appd.sock
    environment:
      # These environment variables are injected from rofl.yaml secrets at runtime
      # --- Core Network Configuration ---
      - NETWORK_NAME=${NETWORK_NAME}
      - BASE_MAINNET_RPC=${BASE_MAINNET_RPC}
      - BASE_SEPOLIA_TESTNET_RPC=${BASE_SEPOLIA_TESTNET_RPC}
      - SAPPHIRE_MAINNET_RPC=${SAPPHIRE_MAINNET_RPC}
      - SAPPHIRE_TESTNET_RPC=${SAPPHIRE_TESTNET_RPC}
      - SAPPHIRE_LOCALNET_RPC=${SAPPHIRE_LOCALNET_RPC}

      # --- Oracle Identity (TEE) ---
      - PRIVATE_KEY=${PRIVATE_KEY}
      - PUBLIC_KEY=${PUBLIC_KEY}

      # --- Smart Contracts ---
      - AI_AGENT_CONTRACT_ADDRESS=${AI_AGENT_CONTRACT_ADDRESS}
      - AI_AGENT_ESCROW_CONTRACT_ADDRESS=${AI_AGENT_ESCROW_CONTRACT_ADDRESS}
      - TOKEN_CONTRACT_ADDRESS=${TOKEN_CONTRACT_ADDRESS}

      # --- Storage Provider (Irys/Arweave) ---
      - IRYS_PAYMENT_PRIVATE_KEY=${IRYS_PAYMENT_PRIVATE_KEY}
      - IRYS_NETWORK=${IRYS_NETWORK}
      - IRYS_PAYMENT_RPC_URL=${IRYS_PAYMENT_RPC_URL}

      # --- Storage Provider (Autonomys) ---
      - AUTONOMYS_API_KEY=${AUTONOMYS_API_KEY}
      - AUTONOMYS_NETWORK=${AUTONOMYS_NETWORK}
      - AUTONOMYS_UPLOAD_CREDIT_THRESHOLD=${AUTONOMYS_UPLOAD_CREDIT_THRESHOLD}
      - AUTONOMYS_MIN_UPLOAD_CREDITS=${AUTONOMYS_MIN_UPLOAD_CREDITS}

      # --- AI Inference Providers ---
      - AI_PROVIDER=${AI_PROVIDER}
      - OLLAMA_URL=${OLLAMA_URL}
      - CHAIN_GPT_API_KEY=${CHAIN_GPT_API_KEY}

      # --- Alerting & Notifications ---
      - SLACK_ACCESS_TOKEN=${SLACK_ACCESS_TOKEN}
      - SLACK_ALERT_CHANNEL=${SLACK_ALERT_CHANNEL}
      - SEND_GRID_API_KEY=${SEND_GRID_API_KEY}
      - SEND_GRID_ALERT_TEMPLATE_ID=${SEND_GRID_ALERT_TEMPLATE_ID}
      - ALERT_FROM_EMAIL=${ALERT_FROM_EMAIL}
      - ALERT_FROM_NAME=${ALERT_FROM_NAME}
      - ALERT_TO_EMAIL=${ALERT_TO_EMAIL}

      # --- Tuning ---
      - EVENT_BATCH_SIZE=${EVENT_BATCH_SIZE}

      # --- Miscellaneous ---
      - DOMAIN=${DOMAIN}
